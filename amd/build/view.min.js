define(["jquery","core/str","mod_englishcentral/html"],function(a,b,c){var d={};return d.plugin="mod_englishcentral",d.str={},b.get_strings([{key:"searchterm",component:d.plugin}]).done(function(a){d.str.searchterm=a[0]}),d.init=function(b){for(var e in b)d[e]=b[e];a(".activity-title, .thumb-frame").click(function(a){d.play_video(a,this)}),a(".addvideos").click(function(){a("#"+d.playercontainer).html("");var b="";b+=c.tag("span",d.str.searchterm,{"class":"search-prompt"}),b+=c.input("searchterm","text",{size:30}),b+=c.input("searchbutton","submit",{value:"Go"}),b=c.tag("div",b,{"class":"search-box"}),b+=c.tag("div","",{"class":"search-results"}),a("#"+d.playercontainer).html(b),a("#id_searchbutton").click(function(){var b=a("#id_searchterm").val();""==b?a(".search-results").html("Please enter one or more search term."):d.search_videos(b)})})},d.play_video=function(b,c){a("#"+d.playercontainer).html(""),window.ECSDK.loadWidget("player",{partnerSdkToken:d.sdktoken,partnerKey:d.consumerkey,container:d.playercontainer,dialogId:d.get_videoid(c)}),b.preventDefault(),b.stopPropagation()},d.search_videos=function(b){a.ajax({url:d.searchurl,type:"GET",data:{term:b,page:"0",pageSize:"20"},dataType:"json",headers:{Accept:d.accept,Authorization:d.authorization,"Content-Type":"application/json"},success:function(a){d.format_results(a)}})},d.format_results=function(b){var e=d.get_videoids(),f="";f+=c.tag("p",b.count+" items found");for(var g=0;g<b.results.length;g++){var h=b.results[g].value.dialogID.toString();e.indexOf(h)<0&&(f+=d.format_result(b.results[g]))}a(".search-results").html(f);for(var g=0;g<b.results.length;g++){var i=b.results[g].value,j={dialogId:i.dialogID,title:i.title,duration:i.duration,difficulty:i.difficulty,dialogURL:i.dialogURL,thumbnailURL:i.thumbnailURL},h="#id_add_video_"+j.dialogId;a(h).data(j),a(h).click(function(a){d.add_video(a,this)})}},d.get_videoids=function(){var b=[];return a(".englishcentral_videos .activity-title").each(function(){b.push(d.get_videoid(this))}),b},d.get_videoid=function(b){return a(b).prop("href").replace(new RegExp("^.*/"),"")},d.add_video=function(b,c){a.ajax({url:d.addvideourl,data:{id:d.cmid,data:a(c).data(),action:"addvideo",sesskey:d.moodlesesskey},dataType:"html",success:function(b){a(b).insertBefore(".addvideos").find("a").click(function(a){d.play_video(a,this)})}}),a(c).closest(".result-item").fadeTo(1e3,.01,function(){a(this).slideUp(150,function(){a(this).remove()})})},d.format_result=function(a){var b="";return b+=d.format_add(a),b+=d.format_thumb(a),b+=d.format_info(a),c.tag("div",b,{"class":"result-item"})},d.format_add=function(b){var d=c.emptytag("img",{src:a(".addvideos .icon").prop("src"),title:"Add this video"});return c.tag("div",d,{"class":"result-add",id:"id_add_video_"+b.value.dialogID})},d.format_thumb=function(a){var b=a.value.duration.replace(new RegExp("^00:"),""),d="";return d+=c.starttag("a",{"class":"thumb-frame",href:a.value.dialogURL,style:"background-image: url('"+a.value.thumbnailURL+"')"}),d+=c.tag("div",a.value.difficulty,{"class":"result-difficulty"}),d+=c.tag("div",b,{"class":"result-duration"}),d+=c.endtag("a"),c.tag("div",d,{"class":"result-thumb"})},d.format_info=function(a){var b="";return b+=c.tag("h2",a.value.title,{"class":"result-title"}),b+=d.format_details(a),c.tag("div",b,{"class":"result-info"})},d.format_details=function(a){var b="";return b+=d.format_topics(a.value.topics),b+=d.format_description(a.value.description),b+=d.format_transcript(a.highlights.transcript),c.tag("dl",b,{"class":"result-details"})},d.format_topics=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].name);return 0==b.length?"":d.format_detail("Topics",b.join(", "))},d.format_description=function(a){return a&&a?d.format_detail("Description",a):""},d.format_transcript=function(a){if(a&&a.length){var b="...",c=new RegExp("//","g");return d.format_detail("Transcript",b+a[0].replace(c,b)+b)}return""},d.format_detail=function(a,b){var d="";return d+=c.tag("dt",a,{"class":"result-label"}),d+=c.tag("dd",b,{"class":"result-value"})},d});