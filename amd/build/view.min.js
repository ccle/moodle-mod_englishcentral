define(["jquery","jqueryui","core/str","mod_englishcentral/html"],function(a,b,c,d){var e={};return e.plugin="mod_englishcentral",e.playercontainer="id_playercontainer",e.progresscontainer="id_progresscontainer",e.str={},c.get_strings([{key:"addthisvideo",component:e.plugin},{key:"advanced",component:e.plugin},{key:"beginner",component:e.plugin},{key:"clickwhenfinished",component:e.plugin},{key:"confirmremovevideo",component:e.plugin},{key:"description",component:e.plugin},{key:"entersearchterm",component:e.plugin},{key:"goals",component:e.plugin},{key:"intermediate",component:e.plugin},{key:"searchterm",component:e.plugin},{key:"topics",component:e.plugin},{key:"transcript",component:e.plugin}]).done(function(a){var b=0;e.str.addthisvideo=a[b++],e.str.advanced=a[b++],e.str.beginner=a[b++],e.str.clickwhenfinished=a[b++],e.str.confirmremovevideo=a[b++],e.str.description=a[b++],e.str.entersearchterm=a[b++],e.str.goals=a[b++],e.str.intermediate=a[b++],e.str.searchterm=a[b++],e.str.topics=a[b++],e.str.transcript=a[b++]}),e.init=function(b){for(var c in b)e[c]=b[c];a(".activity-title, .thumb-frame").click(function(a){return e.play_video(a,this),a.stopPropagation(),a.preventDefault(),!1}),a(".englishcentral_videos").sortable({cursor:"move",items:".activity-thumbnail",update:function(b,c){var d=c.item.find(".activity-title").prop("href"),f={dialogId:e.get_videoid_from_href(d),sortorder:c.item.index()+1};a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:f,action:"sortvideo",sesskey:e.moodlesesskey},dataType:"html",success:function(b){b&&a("#"+e.playercontainer).html(b)}})}}),a(".removevideo").droppable({drop:function(b,c){if(confirm(e.str.confirmremovevideo)){c.draggable.remove();var d=c.draggable.find(".activity-title").prop("href"),f={dialogId:e.get_videoid_from_href(d)};a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:f,action:"removevideo",sesskey:e.moodlesesskey},dataType:"html",success:function(b){b&&a("#"+e.playercontainer).html(b)}})}}}),a(".addvideo").click(function(){var b=document.getElementById(e.playercontainer);b?a("#"+e.playercontainer).html(""):(b=document.createElement("DIV"),b.setAttribute("id",e.playercontainer),a(e.progresscontainer).after(b));var c="";c+=d.tag("span",e.str.searchterm,{"class":"search-prompt"}),c+=d.input("searchterm","text",{size:30}),c+=d.input("searchbutton","submit",{value:"Go"}),c=d.tag("div",c,{"class":"search-box"}),c+=d.tag("div","",{"class":"search-results"}),a("#"+e.playercontainer).html(c),a("#id_searchbutton").click(function(){var b=a("#id_searchterm").val(),c=new RegExp("^s*[0-9]+([, \\t\\r\\n]+[0-9]+)*s*$");""==b?a(".search-results").html(e.str.entersearchterm):b.match(c)?e.fetch_videos(b):e.search_videos(b)})})},e.play_video=function(b,c){a("#"+e.playercontainer).html("");var d="setOnModeEndHandler";window.ECSDK.setOnProgressEventHandler&&(d="setOnProgressEventHandler"),window.ECSDK[d](function(b){switch(b.eventType){case"CompleteActivityWatch":case"LearnedWord":case"DialogLineSpeak":break;case"CompleteActivityLearn":case"CompleteActivitySpeak":return!1;case"StartActivityWatch":case"DialogLineWatch":case"StartActivityLearn":case"TypedWord":case"StudiedWord":case"StartActivitySpeak":return!1}a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:{dialogID:b.dialogID,sdktoken:e.sdktoken},action:"storeresults",sesskey:e.moodlesesskey},dataType:"html",success:function(b){b.indexOf("englishcentral_progress")<0?a(".englishcentral_progress").html(b):a(".englishcentral_progress").replaceWith(b)}}).then(function(){a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:{dialogID:b.dialogID,sdktoken:e.sdktoken},action:"showstatus",sesskey:e.moodlesesskey},dataType:"html",success:function(c){var d=a(".thumb-frame[href$="+b.dialogID+"]");d.find(".watch-status, .learn-status, .speak-status").remove(),d.find(".play-icon").after(c)}})})});var f={partnerKey:e.consumerkey,partnerSdkToken:e.sdktoken,siteLanguage:e.sitelanguage,container:e.playercontainer,dialogId:e.get_videoid(c),interstitialsEnabled:!0,learnMode:!0,speakMode:!0,quizMode:!0,width:640},g=window.outerWidth-a("#"+e.playercontainer).offset().left-24;f.width>g?f.width=g:g>1e3?f.width=1e3:f.height=655,window.ECSDK.loadWidget("player",f)},e.fetch_videos=function(b){var c=new RegExp("[, \\t\\r\\n]+","g"),d=b.replace(c,",");a.ajax({url:e.fetchurl,type:"GET",data:{dialogIDs:d,siteLanguage:e.siteanguage,page:"0",pageSize:"20"},dataType:"json",headers:{Accept:e.accept1,Authorization:e.authorization,"Content-Type":"application/json"},success:function(a){e.format_results(a)}})},e.search_videos=function(b){a.ajax({url:e.searchurl,type:"GET",data:{term:b,page:"0",pageSize:"20"},dataType:"json",headers:{Accept:e.accept1,Authorization:e.authorization,"Content-Type":"application/json"},success:function(a){e.format_results(a)}})},e.format_results=function(b){if(!b||!b.results||0==b.results.length)return"";for(var f="",g=e.get_videoids(),h=0;h<b.results.length;h++){var i=b.results[h].value.dialogID.toString();g.indexOf(i)<0&&(f+=e.format_result(b.results[h]))}a(".search-results").html(f),c.get_string("xitemsfound",e.plugin,b.count).done(function(b){a(".search-results").prepend(d.tag("p",b))});for(var h=0;h<b.results.length;h++){var j=b.results[h].value,k={dialogId:j.dialogID,title:j.title,duration:j.duration,difficulty:j.difficulty,dialogURL:j.dialogURL,thumbnailURL:j.thumbnailURL},i="#id_add_video_"+k.dialogId;a(i).data(k),a(i).click(function(a){e.add_video(a,this)}),a(i).siblings(".result-info").find(".icon").click(function(){var b=a(this).closest(".result-info").siblings(".result-add").prop("id");b=e.get_videoid_from_id(b);var c=Math.min(640,window.innerWidth),d=Math.min(480,window.innerHeight),f=window.outerWidth/2+window.screenX-c/2,g=window.outerHeight/2+window.screenY-d/2,h="width="+c+",height="+d+",top="+g+",left="+f,i=window.open(e.videoinfourl+"/"+b,e.targetwindow,h);i.focus&&i.focus()})}},e.get_videoids=function(){var b=[];return a(".englishcentral_videos .activity-title").each(function(){b.push(e.get_videoid(this))}),b},e.get_videoid=function(b){return e.get_videoid_from_href(a(b).prop("href"))},e.get_videoid_from_href=function(a){return a.replace(new RegExp("^.*/"),"")},e.get_videoid_from_id=function(a){return a.replace(new RegExp("^.*_"),"")},e.add_video=function(b,c){a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:a(c).data(),action:"addvideo",sesskey:e.moodlesesskey},dataType:"html",success:function(b){a(b).insertBefore(".removevideo").find("a").click(function(a){return e.play_video(a,this),a.stopPropagation(),a.preventDefault(),!1})}}),a(c).closest(".result-item").fadeTo(1e3,.01,function(){a(this).slideUp(150,function(){a(this).remove()})})},e.format_result=function(a){var b="";return b+=e.format_add(a),b+=e.format_thumb(a),b+=e.format_info(a),d.tag("div",b,{"class":"result-item"})},e.format_add=function(b){var c=a(".addvideo img").prop("src").replace("addvideo","add"),f=d.emptytag("img",{src:c,title:e.str.addthisvideo});return d.tag("div",f,{"class":"result-add",id:"id_add_video_"+b.value.dialogID})},e.format_thumb=function(a){var b=a.value.duration.replace(new RegExp("^00:"),""),c="";return c+=d.starttag("a",{"class":"thumb-frame",href:a.value.dialogURL,style:"background-image: url('"+a.value.thumbnailURL+"')"}),c+=d.tag("div",a.value.difficulty,{"class":"result-difficulty"}),c+=d.tag("div",b,{"class":"result-duration"}),c+=d.endtag("a"),d.tag("div",c,{"class":"result-thumb"})},e.format_info=function(b){var c="",f=a(".addvideo img").prop("src").replace("addvideo","i/info").replace("mod_englishcentral","core"),g=d.emptytag("img",{src:f,"class":"icon"});return c+=d.tag("h2",b.value.title+g,{"class":"result-title"}),c+=e.format_details(b),d.tag("div",c,{"class":"result-info"})},e.format_details=function(a){var b="";return b+=e.format_goalstopics(a.value.goals,a.value.topics),b+=e.format_description(a.value.description),b+=e.format_transcript(a.highlights.transcript),d.tag("dl",b,{"class":"result-details"})},e.format_goalstopics=function(a,b){var c=[];if(a&&a.length)for(var d=0;d<a.length;d++)c.push(a[d].title);if(b&&b.length)for(var d=0;d<b.length;d++)c.push(b[d].name);return 0==c.length?"":e.format_detail("topics",c.join(", "))},e.format_description=function(a){return a&&a.length?e.format_detail("description",a):""},e.format_transcript=function(a){if(a&&a.length){var b="...",c=new RegExp("//","g");return e.format_detail("transcript",b+a[0].replace(c,b)+b)}return""},e.format_detail=function(a,b){var c="";return c+=d.tag("dt",e.str[a],{"class":"result-label "+a}),c+=d.tag("dd",b,{"class":"result-value "+a})},e});